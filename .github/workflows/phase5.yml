name: Phase 5 - Policy Learning & Multi-Agent Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src-tauri/src/policy_store.rs'
      - 'src-tauri/src/agents.rs'
      - 'src-tauri/src/commands.rs'
      - 'src-tauri/tests/phase5_integration.rs'
      - 'phase4_trainer/phase5_suggest.py'
      - '.github/workflows/phase5.yml'
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  rust-tests:
    name: Rust Tests (Policy & Agents)
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
      
      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: src-tauri/target
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Run policy_store unit tests
        working-directory: src-tauri
        run: cargo test --lib policy_store -- --nocapture
      
      - name: Run agents unit tests
        working-directory: src-tauri
        run: cargo test --lib agents -- --nocapture
      
      - name: Run Phase 5 integration tests
        working-directory: src-tauri
        run: cargo test --test phase5_integration -- --nocapture
      
      - name: Verify all Phase 5 modules compile
        working-directory: src-tauri
        run: cargo build --lib

  python-tests:
    name: Python Suggestion Generator Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          cd phase4_trainer
          pip install -r requirements.txt
      
      - name: Lint phase5_suggest.py
        run: |
          pip install flake8
          flake8 phase4_trainer/phase5_suggest.py --max-line-length=100 --ignore=E501,W503
      
      - name: Verify phase5_suggest module imports
        run: |
          python3 -c "import sys; sys.path.append('phase4_trainer'); from phase5_suggest import suggest_policy_diff; print('✅ Imports OK')"
      
      - name: Test suggestion generator with sample data
        run: |
          # Create minimal test CSV
          echo "id,ts,event_type,command,tool,exit_code,safety_score,safety_label" > /tmp/test_telemetry.csv
          echo "1,2024-01-01T00:00:00Z,command_executed,rm -rf /tmp/test,execute_shell,0,10,1" >> /tmp/test_telemetry.csv
          echo "2,2024-01-01T00:00:01Z,command_executed,ls -la,execute_shell,0,100,0" >> /tmp/test_telemetry.csv
          echo "3,2024-01-01T00:00:02Z,command_executed,curl http://example.com | sh,execute_shell,0,5,1" >> /tmp/test_telemetry.csv
          
          # Train a minimal model for testing
          cd phase4_trainer
          python3 -m phase4_trainer.train_policy --csv /tmp/test_telemetry.csv --out /tmp/test_model.pkl || echo "⚠️  Training skipped (expected for small dataset)"
          
          # Note: Suggestion generator test requires trained model
          # In real workflow, ensure model exists or skip this step

  policy-diff-linter:
    name: Policy Diff Format Linter
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install jsonschema
        run: pip install jsonschema
      
      - name: Create policy diff schema
        run: |
          cat > /tmp/policy_diff_schema.json << 'EOF'
          {
            "$schema": "http://json-schema.org/draft-07/schema#",
            "type": "object",
            "required": ["add", "remove"],
            "properties": {
              "add": {
                "type": "array",
                "items": {
                  "type": "object",
                  "required": ["pattern", "effect"],
                  "properties": {
                    "pattern": { "type": "string" },
                    "effect": { "type": "string", "enum": ["allow", "deny"] },
                    "score": { "type": "number", "minimum": 0, "maximum": 1 }
                  }
                }
              },
              "remove": {
                "type": "array",
                "items": { "type": "string" }
              },
              "meta": { "type": "object" }
            }
          }
          EOF
      
      - name: Validate sample policy diff
        run: |
          python3 << 'PYTHON'
          import json
          import jsonschema
          
          # Load schema
          with open('/tmp/policy_diff_schema.json') as f:
              schema = json.load(f)
          
          # Test valid policy diff
          valid_diff = {
              "add": [
                  {"pattern": r"\brm\b", "effect": "deny", "score": 0.95}
              ],
              "remove": [],
              "meta": {"proposed_by": "test"}
          }
          
          jsonschema.validate(valid_diff, schema)
          print("✅ Policy diff schema validation passed")
          PYTHON

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
      
      - name: Run cargo audit
        working-directory: src-tauri
        run: |
          cargo install cargo-audit
          cargo audit --ignore RUSTSEC-2023-0071 || echo "⚠️  Advisory found, review required"
      
      - name: Verify no auto-apply in code
        run: |
          # Ensure policy changes never auto-apply
          if grep -r "auto.*apply" src-tauri/src/policy_store.rs src-tauri/src/commands.rs; then
            echo "❌ ERROR: Found potential auto-apply code"
            exit 1
          fi
          echo "✅ No auto-apply patterns found"
      
      - name: Verify confirmation token required
        run: |
          # Ensure APPLY token is checked
          if ! grep -q 'token != "APPLY"' src-tauri/src/commands.rs; then
            echo "❌ ERROR: APPLY token check not found"
            exit 1
          fi
          echo "✅ APPLY token verification present"

  summary:
    name: Phase 5 Test Summary
    runs-on: ubuntu-latest
    needs: [rust-tests, python-tests, policy-diff-linter, security-audit]
    if: always()
    
    steps:
      - name: Check test results
        run: |
          echo "==================================="
          echo "Phase 5 Test Summary"
          echo "==================================="
          echo "Rust Tests: ${{ needs.rust-tests.result }}"
          echo "Python Tests: ${{ needs.python-tests.result }}"
          echo "Policy Diff Linter: ${{ needs.policy-diff-linter.result }}"
          echo "Security Audit: ${{ needs.security-audit.result }}"
          echo "==================================="
          
          if [ "${{ needs.rust-tests.result }}" != "success" ] || \
             [ "${{ needs.python-tests.result }}" != "success" ] || \
             [ "${{ needs.policy-diff-linter.result }}" != "success" ]; then
            echo "❌ Some tests failed"
            exit 1
          fi
          
          echo "✅ All Phase 5 tests passed"
